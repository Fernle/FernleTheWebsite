<!DOCTYPE html>
<html class="dark" lang="en">
<head>
    <meta charset="utf-8"/>
    <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
    <title>Admin Panel - Portfolio Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght@400&display=swap" rel="stylesheet"/>
    <!-- EasyMDE CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.css">
    <script src="https://cdn.jsdelivr.net/npm/easymde/dist/easymde.min.js"></script>
    <style>
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #0f0a18; color: white; scroll-behavior: smooth; }
        .glass { background: rgba(24, 18, 38, 0.95); backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.05); }
        input[type=range] { accent-color: #5b13ec; height: 6px; appearance: none; background: rgba(0,0,0,0.4); border-radius: 999px; }
        input[type=range]::-webkit-slider-thumb { appearance: none; width: 18px; height: 18px; background: #5b13ec; border-radius: 50%; cursor: pointer; box-shadow: 0 0 10px rgba(91, 19, 236, 0.5); }
        .hidden { display: none; }
        
        /* Checkbox Custom Style */
        .role-checkbox:checked + div { background-color: #5b13ec; border-color: #5b13ec; color: white; }

        /* Calendar Styles */
        .calendar-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; border-radius: 8px; transition: all 0.2s; }
        .calendar-day:hover { background-color: rgba(255,255,255,0.1); }
        .calendar-day.active { background-color: #5b13ec; color: white; font-weight: bold; }
        .calendar-day.has-log { border: 1px solid #5b13ec; }

        /* EasyMDE Dark Theme Overrides */
        .EasyMDEContainer { background: transparent; border: none; }
        .editor-toolbar { background-color: rgba(255,255,255,0.05) !important; border-color: rgba(255,255,255,0.1) !important; color: #fff !important; }
        .editor-toolbar i { color: #ccc !important; }
        .editor-toolbar i:hover { color: #fff !important; }
        .editor-toolbar button:hover { background: rgba(255,255,255,0.1) !important; }
        .CodeMirror { background-color: rgba(0,0,0,0.3) !important; border-color: rgba(255,255,255,0.1) !important; color: #ddd !important; }
        .CodeMirror-cursor { border-left: 1px solid #fff !important; }
        .editor-preview { background-color: #1e192b !important; color: #ddd !important; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-12 px-6 bg-gradient-to-br from-[#0f0a18] to-[#0a0710]">

    <div id="login-section" class="w-full max-w-md glass rounded-3xl p-10 shadow-2xl mt-20">
        <div class="text-center mb-8">
            <div class="inline-flex items-center justify-center w-16 h-16 bg-purple-600/10 rounded-2xl mb-4 text-purple-500">
                <span class="material-symbols-outlined text-4xl">lock</span>
            </div>
            <h1 class="text-3xl font-black uppercase">Admin Login</h1>
        </div>
        <form id="login-form" class="space-y-4">
            <input type="email" id="login-email" placeholder="Email" required class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:border-purple-500 focus:outline-none">
            <input type="password" id="login-password" placeholder="Password" required class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:border-purple-500 focus:outline-none">
            <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-4 rounded-xl font-bold transition-all shadow-lg">Login</button>
        </form>
    </div>

    <div id="admin-section" class="w-full max-w-3xl hidden space-y-8">
        
        <div class="flex items-center justify-between">
            <h1 class="text-2xl font-black tracking-tighter flex items-center gap-2">
                <span class="material-symbols-outlined text-purple-500">dashboard</span> ADMIN PANEL
            </h1>
            <button onclick="handleLogout()" class="bg-red-500/10 hover:bg-red-500/20 text-red-400 px-4 py-2 rounded-xl text-sm font-bold flex items-center gap-2 transition-all">
                <span class="material-symbols-outlined text-lg">logout</span> Logout
            </button>
        </div>

        <div class="flex gap-4 p-2 bg-black/20 rounded-2xl border border-white/5 overflow-x-auto">
            <button onclick="switchAdminTab('gamer')" id="tab-gamer-btn" class="flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all bg-purple-600 text-white shadow-lg flex items-center justify-center gap-2 whitespace-nowrap">
                <span class="material-symbols-outlined text-lg">sports_esports</span> GAMER
            </button>
            <button onclick="switchAdminTab('developer')" id="tab-developer-btn" class="flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all text-gray-400 hover:bg-white/5 flex items-center justify-center gap-2 whitespace-nowrap">
                <span class="material-symbols-outlined text-lg">code</span> DEVELOPER
            </button>
            <button onclick="switchAdminTab('devlog')" id="tab-devlog-btn" class="flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all text-gray-400 hover:bg-white/5 flex items-center justify-center gap-2 whitespace-nowrap">
                <span class="material-symbols-outlined text-lg">history_edu</span> DEVLOG
            </button>
            <button onclick="switchAdminTab('socials')" id="tab-socials-btn" class="flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all text-gray-400 hover:bg-white/5 flex items-center justify-center gap-2 whitespace-nowrap">
                <span class="material-symbols-outlined text-lg">share</span> SOCIALS
            </button>
        </div>

        <!-- GAMER CONTENT -->
        <div id="gamer-admin-content" class="space-y-8">
            <div class="glass rounded-[32px] p-8 md:p-12 shadow-2xl">
                <h1 id="form-title" class="text-3xl font-black mb-8">Add New Game</h1>
                <form id="game-form" class="space-y-6">
                    <input type="hidden" id="editing-id" value="">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <input type="text" id="title" required placeholder="Game Title" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:border-purple-500 focus:outline-none">
                        <input type="url" id="image_URL" required placeholder="Poster URL (Vertical)" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:border-purple-500 focus:outline-none">
                    </div>
                    <input type="text" id="play_time" placeholder="Play Time (e.g. +900 hours)" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:border-purple-500 focus:outline-none">
                    <div id="sliders-container" class="space-y-6 bg-black/20 p-6 rounded-2xl border border-white/5"></div>
                    <div class="flex items-center justify-between p-6 bg-purple-600/10 rounded-2xl border border-purple-500/20">
                        <span class="font-bold uppercase text-sm text-purple-300 tracking-widest">Live Total Score</span>
                        <span id="total-preview" class="text-5xl font-black">2.5</span>
                    </div>
                    <button type="submit" id="save-btn" class="w-full bg-purple-600 hover:bg-purple-700 text-white font-black py-5 rounded-2xl transition-all shadow-xl flex items-center justify-center gap-3">
                        <span class="material-symbols-outlined">save</span> SAVE TO LIBRARY
                    </button>
                    <button type="button" id="cancel-edit" onclick="resetForm()" class="w-full hidden text-gray-400 hover:text-white text-sm font-bold">Cancel Editing</button>
                </form>
            </div>

            <div class="glass rounded-[32px] p-8 shadow-2xl">
                <h2 class="text-xl font-black mb-6 flex items-center gap-2">
                    <span class="material-symbols-outlined text-purple-500">inventory_2</span> Current Games
                </h2>
                <div id="admin-game-list" class="grid grid-cols-1 gap-3"></div>
            </div>
        </div>

        <!-- DEVELOPER CONTENT -->
        <div id="developer-admin-content" class="hidden space-y-8">
            <div class="glass rounded-[32px] p-8 md:p-12 shadow-2xl">
                <h1 class="text-3xl font-black mb-10">Add New Project</h1>
                <form id="project-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <input type="text" id="p-title" required placeholder="Project Title" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none">
                        <select id="p-status" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none text-gray-400">
                            <option value="Completed">Completed</option>
                            <option value="In Progress">In Progress</option>
                            <option value="Beta">Beta</option>
                            <option value="Prototype">Prototype</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <input type="text" id="p-youtube" placeholder="YouTube Video ID (örn: dQw4w9WgXcQ)" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none">
                        <input type="text" id="p-images" required placeholder="Gallery URLs (Virgülle ayırın)" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none">
                    </div>

                    <!-- Roles Selection -->
                    <div class="bg-black/20 p-6 rounded-2xl border border-white/5">
                        <label class="block text-sm font-bold text-gray-400 mb-4 uppercase tracking-wider">My Roles in Project</label>
                        <div class="flex flex-wrap gap-3">
                            <label class="cursor-pointer">
                                <input type="checkbox" name="roles" value="Solo Developer" class="role-checkbox hidden">
                                <div class="px-4 py-2 rounded-lg border border-white/10 bg-white/5 text-sm font-bold text-gray-400 transition-all hover:bg-white/10 select-none">Solo Developer</div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="checkbox" name="roles" value="Developer" class="role-checkbox hidden">
                                <div class="px-4 py-2 rounded-lg border border-white/10 bg-white/5 text-sm font-bold text-gray-400 transition-all hover:bg-white/10 select-none">Developer</div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="checkbox" name="roles" value="Game Designer" class="role-checkbox hidden">
                                <div class="px-4 py-2 rounded-lg border border-white/10 bg-white/5 text-sm font-bold text-gray-400 transition-all hover:bg-white/10 select-none">Game Designer</div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="checkbox" name="roles" value="Level Designer" class="role-checkbox hidden">
                                <div class="px-4 py-2 rounded-lg border border-white/10 bg-white/5 text-sm font-bold text-gray-400 transition-all hover:bg-white/10 select-none">Level Designer</div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="checkbox" name="roles" value="Narrative Designer" class="role-checkbox hidden">
                                <div class="px-4 py-2 rounded-lg border border-white/10 bg-white/5 text-sm font-bold text-gray-400 transition-all hover:bg-white/10 select-none">Narrative Designer</div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="checkbox" name="roles" value="Artist" class="role-checkbox hidden">
                                <div class="px-4 py-2 rounded-lg border border-white/10 bg-white/5 text-sm font-bold text-gray-400 transition-all hover:bg-white/10 select-none">Artist</div>
                            </label>
                            <label class="cursor-pointer">
                                <input type="checkbox" name="roles" value="Sound Designer" class="role-checkbox hidden">
                                <div class="px-4 py-2 rounded-lg border border-white/10 bg-white/5 text-sm font-bold text-gray-400 transition-all hover:bg-white/10 select-none">Sound Designer</div>
                            </label>
                        </div>
                    </div>

                    <textarea id="p-desc" required placeholder="Project Description" rows="4" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none"></textarea>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <input type="url" id="p-demo" placeholder="Live Demo URL" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none">
                        <input type="url" id="p-github" placeholder="GitHub Repo URL" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:border-blue-500 focus:outline-none">
                    </div>
                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-black py-5 rounded-2xl transition-all shadow-xl flex items-center justify-center gap-3">
                        <span class="material-symbols-outlined">rocket_launch</span> DEPLOY PROJECT
                    </button>
                </form>
            </div>
        </div>

        <!-- DEVLOG CONTENT -->
        <div id="devlog-admin-content" class="hidden space-y-8">
            <!-- Calendar & List Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Calendar -->
                <div class="glass rounded-[32px] p-6 shadow-2xl">
                    <div class="flex justify-between items-center mb-4">
                        <h2 id="current-month" class="text-xl font-bold">Month Year</h2>
                        <div class="flex gap-2">
                            <button onclick="changeMonth(-1)" class="p-2 hover:bg-white/10 rounded-full"><span class="material-symbols-outlined">chevron_left</span></button>
                            <button onclick="changeMonth(1)" class="p-2 hover:bg-white/10 rounded-full"><span class="material-symbols-outlined">chevron_right</span></button>
                        </div>
                    </div>
                    <div class="grid grid-cols-7 gap-2 text-center text-sm font-bold text-gray-500 mb-2">
                        <div>Su</div><div>Mo</div><div>Tu</div><div>We</div><div>Th</div><div>Fr</div><div>Sa</div>
                    </div>
                    <div id="calendar-grid" class="grid grid-cols-7 gap-2"></div>
                </div>

                <!-- Log List for Selected Date -->
                <div class="glass rounded-[32px] p-6 shadow-2xl flex flex-col">
                    <h2 class="text-xl font-bold mb-4 flex items-center gap-2">
                        <span class="material-symbols-outlined text-green-500">event_note</span>
                        Logs for <span id="selected-date-display" class="text-green-400">Today</span>
                    </h2>
                    <div id="day-logs-list" class="flex-1 overflow-y-auto max-h-[300px] space-y-3 pr-2">
                        <p class="text-gray-500 text-center py-10">Select a date to view logs.</p>
                    </div>
                    <button onclick="resetDevlogForm()" class="mt-4 w-full bg-white/5 hover:bg-white/10 text-white py-3 rounded-xl font-bold transition-all flex items-center justify-center gap-2">
                        <span class="material-symbols-outlined">add</span> Create New Log
                    </button>
                </div>
            </div>

            <!-- Editor Form -->
            <div class="glass rounded-[32px] p-8 md:p-12 shadow-2xl">
                <h1 id="devlog-form-title" class="text-3xl font-black mb-10">Add New Devlog</h1>
                <form id="devlog-form" class="space-y-6">
                    <input type="hidden" id="d-id" value="">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <input type="text" id="d-title" required placeholder="Log Title (e.g. Fixed collision bug)" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none">
                        <select id="d-category" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none text-gray-400">
                            <option value="Bug Fix">Bug Fix</option>
                            <option value="Feature">Feature</option>
                            <option value="Update">Update</option>
                            <option value="Learning">Learning</option>
                            <option value="Planning">Planning</option>
                            <option value="AFK & Gaming">AFK & Gaming</option>
                            <option value="Milestone">Milestone</option>
                        </select>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <input type="text" id="d-icon" placeholder="Icon Name (e.g. bug_report, code, school)" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none">
                        <input type="text" id="d-color" placeholder="Color Class (e.g. text-red-400)" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none">
                    </div>

                    <!-- Custom Toolbar & EasyMDE Editor -->
                    <div class="flex flex-col gap-2">
                        <div class="flex gap-2 bg-black/20 p-2 rounded-t-xl border border-white/10 border-b-0">
                            <button type="button" onclick="insertCustomLink()" class="p-2 hover:bg-white/10 rounded text-gray-400 hover:text-white" title="Insert Link">
                                <span class="material-symbols-outlined text-sm">link</span>
                            </button>
                        </div>
                        <textarea id="d-content"></textarea>
                    </div>
                    
                    <textarea id="d-code" placeholder="Code Snippet (Optional)" rows="4" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:border-green-500 focus:outline-none font-mono text-sm"></textarea>
                    
                    <button type="submit" id="d-submit-btn" class="w-full bg-green-600 hover:bg-green-700 text-white font-black py-5 rounded-2xl transition-all shadow-xl flex items-center justify-center gap-3">
                        <span class="material-symbols-outlined">history_edu</span> PUBLISH LOG
                    </button>
                </form>
            </div>
        </div>

        <!-- SOCIALS CONTENT -->
        <div id="socials-admin-content" class="hidden space-y-8">
            <div class="glass rounded-[32px] p-8 md:p-12 shadow-2xl">
                <h1 class="text-3xl font-black mb-10">Manage Socials</h1>
                <form id="social-form" class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <input type="text" id="s-platform" required placeholder="Platform Name (e.g. GitHub)" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:border-pink-500 focus:outline-none">
                        <input type="url" id="s-url" required placeholder="Profile URL" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:border-pink-500 focus:outline-none">
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <input type="text" id="s-icon" required placeholder="Icon Name (e.g. terminal, work)" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:border-pink-500 focus:outline-none">
                        <input type="text" id="s-color" placeholder="Color Class (e.g. text-blue-400)" class="w-full bg-black/40 border border-white/10 rounded-xl px-4 py-3 focus:border-pink-500 focus:outline-none">
                    </div>

                    <button type="submit" class="w-full bg-pink-600 hover:bg-pink-700 text-white font-black py-5 rounded-2xl transition-all shadow-xl flex items-center justify-center gap-3">
                        <span class="material-symbols-outlined">share</span> ADD SOCIAL LINK
                    </button>
                </form>
            </div>

            <div class="glass rounded-[32px] p-8 shadow-2xl">
                <h2 class="text-xl font-black mb-6 flex items-center gap-2">
                    <span class="material-symbols-outlined text-pink-500">link</span> Active Links
                </h2>
                <div id="admin-socials-list" class="grid grid-cols-1 gap-3"></div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        const SB_URL = 'https://rhnjzjwbnukwgfpdkpqk.supabase.co';
        const SB_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InJobmp6andibnVrd2dmcGRrcHFrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY0OTI0MTMsImV4cCI6MjA4MjA2ODQxM30.PxkMYz8db04M4yzQWkw_ZmMEIU0d3RAbNoVAFsfm778';
        const _supabase = supabase.createClient(SB_URL, SB_KEY);

        const stats = ['gameplay', 'narrative', 'presentation', 'technical', 'impact'];

        // EasyMDE Instance
        let easyMDE;
        let calendarInitialized = false; // Flag to prevent duplicate calendar init

        // --- GAMER LOGIC ---
        const container = document.getElementById('sliders-container');
        stats.forEach(s => {
            container.innerHTML += `
                <div class="space-y-2">
                    <div class="flex justify-between items-center text-sm font-bold">
                        <label class="capitalize">${s}</label>
                        <span id="v-${s}" class="text-purple-400 bg-purple-500/10 px-2 py-1 rounded-md text-xs">2.5</span>
                    </div>
                    <input type="range" id="rating_${s}" min="0" max="1" step="0.5" value="2.5" oninput="updateScores()" class="w-full">
                </div>
            `;
        });

        function updateScores() {
            let sum = 0;
            stats.forEach(s => {
                const val = parseFloat(document.getElementById('rating_' + s).value);
                document.getElementById('v-' + s).innerText = val;
                sum += val;
            });
            document.getElementById('total-preview').innerText = sum.toFixed(1);
        }
        
        // FIX: Call updateScores immediately to set initial values correctly
        updateScores();

        // --- AUTH CONTROL ---
        _supabase.auth.onAuthStateChange((event, session) => {
            document.getElementById('login-section').classList.toggle('hidden', !!session);
            document.getElementById('admin-section').classList.toggle('hidden', !session);
            if (session) {
                loadAdminGames();
                loadAdminSocials();
                
                // Prevent duplicate calendar initialization
                if (!calendarInitialized) {
                    initCalendar();
                    calendarInitialized = true;
                }
                
                // Initialize EasyMDE only once
                if (!easyMDE) {
                    easyMDE = new EasyMDE({ 
                        element: document.getElementById('d-content'),
                        spellChecker: false,
                        status: false,
                        placeholder: "Write your devlog here...",
                        toolbar: ["bold", "italic", "heading", "|", "quote", "unordered-list", "ordered-list"], // Link ve Code kaldırıldı
                    });
                }
            }
        });

        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const { error } = await _supabase.auth.signInWithPassword({
                email: document.getElementById('login-email').value,
                password: document.getElementById('login-password').value
            });
            if (error) alert(error.message);
        });

        async function handleLogout() { await _supabase.auth.signOut(); }

        // --- TAB SWITCHING ---
        function switchAdminTab(tab) {
            const contents = {
                'gamer': document.getElementById('gamer-admin-content'),
                'developer': document.getElementById('developer-admin-content'),
                'devlog': document.getElementById('devlog-admin-content'),
                'socials': document.getElementById('socials-admin-content')
            };
            
            const btns = {
                'gamer': document.getElementById('tab-gamer-btn'),
                'developer': document.getElementById('tab-developer-btn'),
                'devlog': document.getElementById('tab-devlog-btn'),
                'socials': document.getElementById('tab-socials-btn')
            };

            // Reset all
            Object.values(contents).forEach(el => el.classList.add('hidden'));
            Object.values(btns).forEach(el => el.className = "flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all text-gray-400 hover:bg-white/5 flex items-center justify-center gap-2 whitespace-nowrap");

            // Activate selected
            contents[tab].classList.remove('hidden');
            
            const colors = {
                'gamer': 'bg-purple-600',
                'developer': 'bg-blue-600',
                'devlog': 'bg-green-600',
                'socials': 'bg-pink-600'
            };
            
            btns[tab].className = `flex-1 py-3 px-4 rounded-xl font-bold text-sm transition-all ${colors[tab]} text-white shadow-lg flex items-center justify-center gap-2 whitespace-nowrap`;
            
            // Refresh EasyMDE if devlog tab is active (sometimes needed for layout)
            if(tab === 'devlog' && easyMDE) {
                setTimeout(() => easyMDE.codemirror.refresh(), 100);
            }
        }

        // --- DATA OPERATIONS (GAMER) ---
        async function loadAdminGames() {
            const { data } = await _supabase.from('games').select('*').order('created_at', { ascending: false });
            const list = document.getElementById('admin-game-list');
            list.innerHTML = data.map(g => `
                <div class="flex items-center justify-between p-4 bg-white/5 rounded-2xl border border-white/5 hover:border-purple-500/30 transition-all">
                    <div class="flex items-center gap-4">
                        <img src="${g.image_URL}" class="w-10 h-14 object-cover rounded-lg">
                        <div class="flex flex-col">
                            <span class="font-bold text-sm">${g.title}</span>
                            ${g.is_featured ? '<span class="text-[10px] text-yellow-500 font-bold uppercase tracking-wider">★ Top 5</span>' : ''}
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="toggleTooOld('${g.id}', ${g.is_too_old})" class="p-2 ${g.is_too_old ? 'text-orange-500 bg-orange-500/10' : 'text-gray-500 hover:bg-white/5'} rounded-xl transition-all" title="Tried but too old"><span class="material-symbols-outlined">hourglass_disabled</span></button>
                        <button onclick="toggleFeatured('${g.id}', ${g.is_featured})" class="p-2 ${g.is_featured ? 'text-yellow-500 bg-yellow-500/10' : 'text-gray-500 hover:bg-white/5'} rounded-xl transition-all"><span class="material-symbols-outlined">crown</span></button>
                        <button onclick="editGame('${g.id}')" class="p-2 hover:bg-purple-500/20 text-purple-400 rounded-xl transition-all"><span class="material-symbols-outlined">edit</span></button>
                    </div>
                </div>
            `).join('');
        }

        document.getElementById('game-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const id = document.getElementById('editing-id').value;
            const gameData = {
                title: document.getElementById('title').value,
                image_URL: document.getElementById('image_URL').value,
                play_time: document.getElementById('play_time').value,
                total_score: parseFloat(document.getElementById('total-preview').innerText)
            };
            stats.forEach(s => gameData['rating_' + s] = parseFloat(document.getElementById('rating_' + s).value));

            const { error } = id 
                ? await _supabase.from('games').update(gameData).eq('id', id)
                : await _supabase.from('games').insert([gameData]);

            if (error) alert(error.message);
            else { alert(id ? "Updated!" : "Saved!"); resetForm(); loadAdminGames(); }
        });

        async function editGame(id) {
            const { data } = await _supabase.from('games').select('*').eq('id', id).single();
            document.getElementById('editing-id').value = data.id;
            document.getElementById('title').value = data.title;
            document.getElementById('image_URL').value = data.image_URL;
            document.getElementById('play_time').value = data.play_time || '';
            stats.forEach(s => document.getElementById('rating_' + s).value = data['rating_' + s]);
            updateScores();
            document.getElementById('form-title').innerText = "Edit Game";
            document.getElementById('save-btn').innerText = "UPDATE GAME";
            document.getElementById('cancel-edit').classList.remove('hidden');
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        function resetForm() {
            document.getElementById('game-form').reset();
            document.getElementById('editing-id').value = '';
            document.getElementById('form-title').innerText = "Add New Game";
            document.getElementById('save-btn').innerText = "SAVE TO LIBRARY";
            document.getElementById('cancel-edit').classList.add('hidden');
            updateScores();
        }

        // --- DATA OPERATIONS (DEVELOPER) ---
        function extractYouTubeID(url) {
            if (!url) return null;
            const regExp = /^.*(youtu.be\/|v\/|u\/\w\/|embed\/|watch\?v=|\&v=)([^#\&\?]*).*/;
            const match = url.match(regExp);
            return (match && match[2].length === 11) ? match[2] : url;
        }

        document.getElementById('project-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const selectedRoles = Array.from(document.querySelectorAll('input[name="roles"]:checked'))
                .map(cb => cb.value)
                .join(', ');
    
            const rawYoutube = document.getElementById('p-youtube').value;
            const youtubeId = extractYouTubeID(rawYoutube);

            const projectData = {
                title: document.getElementById('p-title').value,
                youtube_id: youtubeId,
                image_url: document.getElementById('p-images').value,
                description: document.getElementById('p-desc').value,
                tags: selectedRoles,
                status: document.getElementById('p-status').value,
                demo_url: document.getElementById('p-demo').value || "",
                github_url: document.getElementById('p-github').value || ""
            };

            const { data, error } = await _supabase.from('projects').insert([projectData]);

            if (error) {
                console.error("Supabase Error:", error);
                alert("Hata: " + error.message);
            } else {
                alert("Project Deployed Successfully!");
                document.getElementById('project-form').reset();
                document.querySelectorAll('input[name="roles"]').forEach(cb => cb.checked = false);
            }
        });

        // --- DATA OPERATIONS (DEVLOG) ---
        // Custom Toolbar Functions
        function insertCustomLink() {
            const cm = easyMDE.codemirror;
            const selection = cm.getSelection();
            
            // URL'yi sor
            const url = prompt("Enter URL:", "https://");
            
            if (url) {
                if (selection) {
                    // Seçili metin varsa: [Seçili Metin](URL)
                    cm.replaceSelection(`[${selection}](${url})`);
                } else {
                    // Seçili metin yoksa: [Link](URL)
                    cm.replaceSelection(`[Link](${url})`);
                }
            }
            cm.focus();
        }

        // Calendar Logic
        let currentDate = new Date();
        let selectedDate = new Date();

        async function initCalendar() {
            renderCalendar();
            loadLogsForDate(selectedDate);
        }

        function changeMonth(delta) {
            currentDate.setMonth(currentDate.getMonth() + delta);
            renderCalendar();
        }

        async function renderCalendar() {
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            
            document.getElementById('current-month').innerText = new Date(year, month).toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            
            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            const grid = document.getElementById('calendar-grid');
            grid.innerHTML = '';

            // Fetch logs for this month to mark days
            const startOfMonth = new Date(year, month, 1).toISOString();
            const endOfMonth = new Date(year, month + 1, 0, 23, 59, 59).toISOString();
            
            const { data: logs } = await _supabase
                .from('devlogs')
                .select('created_at')
                .gte('created_at', startOfMonth)
                .lte('created_at', endOfMonth);

            const logDays = new Set(logs?.map(l => new Date(l.created_at).getDate()));

            // Empty slots
            for(let i = 0; i < firstDay; i++) {
                grid.innerHTML += `<div></div>`;
            }

            // Days
            for(let day = 1; day <= daysInMonth; day++) {
                const isSelected = selectedDate.getDate() === day && selectedDate.getMonth() === month && selectedDate.getFullYear() === year;
                const hasLog = logDays.has(day);
                
                const dayEl = document.createElement('div');
                dayEl.className = `calendar-day ${isSelected ? 'active' : ''} ${hasLog ? 'has-log' : ''}`;
                dayEl.innerText = day;
                dayEl.onclick = () => selectDate(day);
                grid.appendChild(dayEl);
            }
        }

        function selectDate(day) {
            selectedDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
            renderCalendar();
            loadLogsForDate(selectedDate);
        }

        async function loadLogsForDate(date) {
            document.getElementById('selected-date-display').innerText = date.toLocaleDateString('en-US', { month: 'long', day: 'numeric' });
            
            const startOfDay = new Date(date.setHours(0,0,0,0)).toISOString();
            const endOfDay = new Date(date.setHours(23,59,59,999)).toISOString();

            const { data: logs } = await _supabase
                .from('devlogs')
                .select('*')
                .gte('created_at', startOfDay)
                .lte('created_at', endOfDay)
                .order('created_at', { ascending: false });

            const list = document.getElementById('day-logs-list');
            if (!logs || logs.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-center py-10">No logs for this date.</p>';
                return;
            }

            list.innerHTML = logs.map(log => `
                <div class="bg-white/5 p-4 rounded-xl border border-white/5 flex justify-between items-start group hover:border-green-500/30 transition-all">
                    <div>
                        <h4 class="font-bold text-sm text-white">${log.title}</h4>
                        <span class="text-xs text-gray-500">${log.category}</span>
                    </div>
                    <div class="flex gap-2 opacity-0 group-hover:opacity-100 transition-opacity">
                        <button onclick="editDevlog('${log.id}')" class="text-blue-400 hover:text-white"><span class="material-symbols-outlined text-lg">edit</span></button>
                        <button onclick="deleteDevlog('${log.id}')" class="text-red-400 hover:text-white"><span class="material-symbols-outlined text-lg">delete</span></button>
                    </div>
                </div>
            `).join('');
        }

        async function editDevlog(id) {
            const { data } = await _supabase.from('devlogs').select('*').eq('id', id).single();
            
            document.getElementById('d-id').value = data.id;
            document.getElementById('d-title').value = data.title;
            document.getElementById('d-category').value = data.category;
            document.getElementById('d-icon').value = data.icon;
            document.getElementById('d-color').value = data.color_class;
            
            // EasyMDE'ye içeriği yükle
            if(easyMDE) easyMDE.value(data.content);
            
            document.getElementById('d-code').value = data.code_snippet || '';
            
            document.getElementById('devlog-form-title').innerText = "Edit Devlog";
            document.getElementById('d-submit-btn').innerText = "UPDATE LOG";
            document.getElementById('d-submit-btn').classList.replace('bg-green-600', 'bg-blue-600');
            document.getElementById('d-submit-btn').classList.replace('hover:bg-green-700', 'hover:bg-blue-700');
        }

        function resetDevlogForm() {
            document.getElementById('devlog-form').reset();
            if(easyMDE) easyMDE.value(""); // Editörü temizle
            document.getElementById('d-id').value = '';
            document.getElementById('devlog-form-title').innerText = "Add New Devlog";
            document.getElementById('d-submit-btn').innerText = "PUBLISH LOG";
            document.getElementById('d-submit-btn').classList.replace('bg-blue-600', 'bg-green-600');
            document.getElementById('d-submit-btn').classList.replace('hover:bg-blue-700', 'hover:bg-green-700');
        }

        async function deleteDevlog(id) {
            if(confirm('Delete this log?')) {
                await _supabase.from('devlogs').delete().eq('id', id);
                loadLogsForDate(selectedDate);
                renderCalendar(); // Refresh calendar dots
            }
        }

        document.getElementById('devlog-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('d-id').value;
            const devlogData = {
                title: document.getElementById('d-title').value,
                category: document.getElementById('d-category').value,
                icon: document.getElementById('d-icon').value || 'article',
                color_class: document.getElementById('d-color').value || 'text-gray-400',
                content: easyMDE ? easyMDE.value() : document.getElementById('d-content').value, // EasyMDE'den değeri al
                code_snippet: document.getElementById('d-code').value || null,
                ...(id ? {} : { created_at: selectedDate.toISOString() })
            };

            const { error } = id 
                ? await _supabase.from('devlogs').update(devlogData).eq('id', id)
                : await _supabase.from('devlogs').insert([devlogData]);

            if (error) {
                console.error("Supabase Error:", error);
                alert("Hata: " + error.message);
            } else {
                alert(id ? "Log Updated!" : "Log Published!");
                resetDevlogForm();
                loadLogsForDate(selectedDate);
                renderCalendar();
            }
        });

        // --- DATA OPERATIONS (SOCIALS) ---
        async function loadAdminSocials() {
            const { data } = await _supabase.from('socials').select('*').order('created_at', { ascending: true });
            const list = document.getElementById('admin-socials-list');
            list.innerHTML = data.map(s => `
                <div class="flex items-center justify-between p-4 bg-white/5 rounded-2xl border border-white/5 hover:border-pink-500/30 transition-all">
                    <div class="flex items-center gap-4">
                        <div class="flex size-10 items-center justify-center rounded-lg bg-white/5 text-white">
                            <span class="material-symbols-outlined">${s.icon}</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="font-bold text-sm">${s.platform}</span>
                            <span class="text-xs text-gray-500 truncate max-w-[200px]">${s.url}</span>
                        </div>
                    </div>
                    <button onclick="deleteSocial('${s.id}')" class="p-2 hover:bg-red-500/20 text-red-400 rounded-xl transition-all">
                        <span class="material-symbols-outlined">delete</span>
                    </button>
                </div>
            `).join('');
        }

        document.getElementById('social-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const socialData = {
                platform: document.getElementById('s-platform').value,
                url: document.getElementById('s-url').value,
                icon: document.getElementById('s-icon').value,
                color_class: document.getElementById('s-color').value || 'text-white',
                is_active: true
            };

            const { data, error } = await _supabase.from('socials').insert([socialData]);

            if (error) {
                console.error("Supabase Error:", error);
                alert("Hata: " + error.message);
            } else {
                alert("Social Link Added!");
                document.getElementById('social-form').reset();
                loadAdminSocials();
            }
        });

        async function deleteSocial(id) {
            if(confirm('Are you sure you want to delete this link?')) {
                await _supabase.from('socials').delete().eq('id', id);
                loadAdminSocials();
            }
        }

        async function toggleFeatured(id, currentStatus) {
            if (!currentStatus) {
                const { count } = await _supabase.from('games').select('*', { count: 'exact', head: true }).eq('is_featured', true);
                if (count >= 5) { alert("Zaten 5 oyun seçili!"); return; }
            }
            await _supabase.from('games').update({ is_featured: !currentStatus }).eq('id', id);
            loadAdminGames();
        }

        async function toggleTooOld(id, currentStatus) {
            await _supabase.from('games').update({ is_too_old: !currentStatus }).eq('id', id);
            loadAdminGames();
        }
    </script>
</body>
</html>